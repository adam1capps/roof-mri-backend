<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roof MRI Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f1f5f9; color: #1B2A4A; }

    .header { background: #1B2A4A; padding: 20px 24px; text-align: center; }
    .header h1 { color: #fff; font-size: 22px; font-weight: 700; letter-spacing: 1px; }
    .header h1 span { color: #00bd70; }
    .header p { color: #94a3b8; font-size: 12px; margin-top: 4px; }

    .container { max-width: 640px; margin: 24px auto; padding: 0 16px; }

    .card { background: #fff; border-radius: 8px; padding: 24px; margin-bottom: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .card h2 { font-size: 16px; color: #1B2A4A; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #00bd70; }

    label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 4px; margin-top: 12px; }
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; color: #1B2A4A; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #00bd70; box-shadow: 0 0 0 2px rgba(0,189,112,0.15); }
    textarea { resize: vertical; min-height: 80px; }

    .btn { display: inline-block; padding: 12px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 16px; }
    .btn-green { background: #00bd70; color: #fff; }
    .btn-green:hover { background: #00a862; }
    .btn-blue { background: #1B2A4A; color: #fff; }
    .btn-blue:hover { background: #243556; }
    .btn-red { background: #ef4444; color: #fff; }
    .btn-red:hover { background: #dc2626; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .response { margin-top: 12px; padding: 12px; border-radius: 6px; font-size: 13px; font-family: monospace; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }
    .response.success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
    .response.error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
    .response.info { background: #f0f9ff; border: 1px solid #bae6fd; color: #0c4a6e; }

    .hidden { display: none; }
    .status-bar { background: #fff; border-radius: 6px; padding: 12px 16px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-dot.green { background: #00bd70; }
    .status-dot.red { background: #ef4444; }
    .status-dot.yellow { background: #eab308; }

    .checkbox-row { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
    .checkbox-row input { width: auto; }
    .checkbox-row label { margin: 0; }

    .proposal-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 12px; }
    .proposal-table th { text-align: left; padding: 8px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; color: #64748b; font-weight: 600; }
    .proposal-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .badge-sent { background: #dbeafe; color: #1e40af; }
    .badge-signed { background: #d1fae5; color: #065f46; }
    .badge-paid { background: #00bd70; color: #fff; }
    .badge-unpaid { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body>

<div class="header">
  <h1>ROOF <span>MRI</span></h1>
  <p>Admin Dashboard</p>
</div>

<div class="container">
  <!-- Status Bar -->
  <div class="status-bar">
    <div>
      <span class="status-dot yellow" id="statusDot"></span>
      <span id="statusText" style="font-size:14px;font-weight:600;">Checking server...</span>
    </div>
    <div id="authStatus" style="font-size:13px;color:#64748b;">Not logged in</div>
  </div>

  <!-- SECTION 1: Setup (only if no admin exists) -->
  <div class="card" id="setupCard">
    <h2>1. Create Admin Account</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:8px;">First-time setup. Create your admin login.</p>
    <label>Email</label>
    <input type="email" id="setupEmail" placeholder="adam@re-dry.com">
    <label>Password</label>
    <input type="password" id="setupPassword" placeholder="Min 10 characters">
    <button class="btn btn-green" onclick="doSetup()">Create Admin Account</button>
    <div id="setupResponse" class="response hidden"></div>
  </div>

  <!-- SECTION 2: Login -->
  <div class="card" id="loginCard">
    <h2>2. Login</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:8px;">Login to access admin features.</p>
    <label>Email</label>
    <input type="email" id="loginEmail" placeholder="adam@re-dry.com">
    <label>Password</label>
    <input type="password" id="loginPassword" placeholder="Your password">
    <button class="btn btn-blue" onclick="doLogin()">Login</button>
    <div id="loginResponse" class="response hidden"></div>
  </div>

  <!-- SECTION 3: Authenticated features (hidden until logged in) -->
  <div id="authSection" class="hidden">

    <!-- Verify Token -->
    <div class="card">
      <h2>Verify Token</h2>
      <button class="btn btn-blue" onclick="doVerify()">Check /api/admin/me</button>
      <div id="verifyResponse" class="response hidden"></div>
    </div>

    <!-- Send Proposal -->
    <div class="card">
      <h2>Send Proposal</h2>
      <p style="font-size:13px;color:#64748b;margin-bottom:8px;">Send a training proposal to a client via email.</p>

      <label>Contact Name *</label>
      <input type="text" id="propName" placeholder="John Smith">

      <label>Company *</label>
      <input type="text" id="propCompany" placeholder="Acme Roofing">

      <label>Client Email *</label>
      <input type="email" id="propEmail" placeholder="client@example.com">

      <label>Tier</label>
      <select id="propTier">
        <option value="">-- Let client choose --</option>
        <option value="professional">Professional</option>
        <option value="regional">Regional</option>
        <option value="enterprise">Enterprise</option>
      </select>

      <label>Total Price ($)</label>
      <input type="number" id="propPrice" placeholder="2500">

      <label>Extra Trainees</label>
      <input type="number" id="propExtraTrainees" value="0" min="0">

      <label>Extra Kits</label>
      <input type="number" id="propExtraKits" value="0" min="0">

      <label>Vimeo URL (optional)</label>
      <input type="url" id="propVimeo" placeholder="https://vimeo.com/123456789">

      <div class="checkbox-row">
        <input type="checkbox" id="propVideography">
        <label for="propVideography">Include Videography</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="propOnRoof">
        <label for="propOnRoof">Include On-Roof Training Day</label>
      </div>

      <button class="btn btn-green" onclick="doSendProposal()">Send Proposal</button>
      <div id="proposalResponse" class="response hidden"></div>
    </div>

    <!-- List Proposals -->
    <div class="card">
      <h2>All Proposals</h2>
      <button class="btn btn-blue" onclick="doListProposals()">Load Proposals</button>
      <div id="proposalsList"></div>
      <div id="proposalsResponse" class="response hidden"></div>
    </div>

    <!-- Logout -->
    <div class="card" style="text-align:center;">
      <button class="btn btn-red" onclick="doLogout()" style="max-width:200px;">Logout</button>
    </div>
  </div>
</div>

<script>
  const API = window.location.origin;
  let token = localStorage.getItem('roofmri_token') || '';

  // On load
  window.addEventListener('DOMContentLoaded', () => {
    checkHealth();
    if (token) {
      showLoggedIn();
      doVerify();
    }
  });

  function headers(json = true) {
    const h = {};
    if (json) h['Content-Type'] = 'application/json';
    if (token) h['Authorization'] = 'Bearer ' + token;
    return h;
  }

  function showResponse(elId, data, isError) {
    const el = document.getElementById(elId);
    el.className = 'response ' + (isError ? 'error' : 'success');
    el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    el.classList.remove('hidden');
  }

  function showLoggedIn() {
    document.getElementById('authSection').classList.remove('hidden');
    document.getElementById('authStatus').textContent = 'Logged in';
    document.getElementById('authStatus').style.color = '#00bd70';
  }

  // Health check
  async function checkHealth() {
    try {
      const res = await fetch(API + '/health');
      const data = await res.json();
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      if (data.status === 'ok') {
        dot.className = 'status-dot green';
        text.textContent = 'Server is running';
      } else {
        dot.className = 'status-dot red';
        text.textContent = 'Server unhealthy';
      }
    } catch (e) {
      document.getElementById('statusDot').className = 'status-dot red';
      document.getElementById('statusText').textContent = 'Cannot reach server';
    }
  }

  // Setup
  async function doSetup() {
    try {
      const res = await fetch(API + '/api/admin/setup', {
        method: 'POST',
        headers: headers(),
        body: JSON.stringify({
          email: document.getElementById('setupEmail').value,
          password: document.getElementById('setupPassword').value,
        })
      });
      const data = await res.json();
      if (data.token) {
        token = data.token;
        localStorage.setItem('roofmri_token', token);
        showLoggedIn();
      }
      showResponse('setupResponse', data, !res.ok);
    } catch (e) {
      showResponse('setupResponse', e.message, true);
    }
  }

  // Login
  async function doLogin() {
    try {
      const res = await fetch(API + '/api/admin/login', {
        method: 'POST',
        headers: headers(),
        body: JSON.stringify({
          email: document.getElementById('loginEmail').value,
          password: document.getElementById('loginPassword').value,
        })
      });
      const data = await res.json();
      if (data.token) {
        token = data.token;
        localStorage.setItem('roofmri_token', token);
        showLoggedIn();
      }
      showResponse('loginResponse', data, !res.ok);
    } catch (e) {
      showResponse('loginResponse', e.message, true);
    }
  }

  // Verify
  async function doVerify() {
    try {
      const res = await fetch(API + '/api/admin/me', { headers: headers(false) });
      const data = await res.json();
      showResponse('verifyResponse', data, !res.ok);
      if (!res.ok) {
        // Token expired
        doLogout();
      }
    } catch (e) {
      showResponse('verifyResponse', e.message, true);
    }
  }

  // Send Proposal
  async function doSendProposal() {
    const tier = document.getElementById('propTier').value;
    const body = {
      contactName: document.getElementById('propName').value,
      company: document.getElementById('propCompany').value,
      email: document.getElementById('propEmail').value,
      tier: tier || null,
      letClientChoose: !tier,
      totalPrice: parseFloat(document.getElementById('propPrice').value) || null,
      extraTrainees: parseInt(document.getElementById('propExtraTrainees').value) || 0,
      extraKits: parseInt(document.getElementById('propExtraKits').value) || 0,
      vimeoUrl: document.getElementById('propVimeo').value || null,
      videography: document.getElementById('propVideography').checked,
      onRoofDay: document.getElementById('propOnRoof').checked,
    };

    try {
      const res = await fetch(API + '/api/send-proposal', {
        method: 'POST',
        headers: headers(),
        body: JSON.stringify(body),
      });
      const data = await res.json();
      showResponse('proposalResponse', data, !res.ok);
    } catch (e) {
      showResponse('proposalResponse', e.message, true);
    }
  }

  // List Proposals
  async function doListProposals() {
    try {
      const res = await fetch(API + '/api/proposals', { headers: headers(false) });
      const data = await res.json();
      if (!res.ok) {
        showResponse('proposalsResponse', data, true);
        return;
      }

      if (data.proposals.length === 0) {
        document.getElementById('proposalsList').innerHTML = '<p style="color:#64748b;font-size:13px;margin-top:12px;">No proposals yet.</p>';
        return;
      }

      let html = '<table class="proposal-table"><thead><tr><th>Company</th><th>Contact</th><th>Status</th><th>Payment</th><th>Date</th></tr></thead><tbody>';
      data.proposals.forEach(p => {
        const statusClass = p.status === 'signed' ? 'badge-signed' : 'badge-sent';
        const payClass = p.payment_status === 'paid' ? 'badge-paid' : 'badge-unpaid';
        const date = new Date(p.created_at).toLocaleDateString();
        html += '<tr>'
          + '<td>' + (p.company || '') + '</td>'
          + '<td>' + (p.contact_name || '') + '</td>'
          + '<td><span class="badge ' + statusClass + '">' + p.status + '</span></td>'
          + '<td><span class="badge ' + payClass + '">' + p.payment_status + '</span></td>'
          + '<td>' + date + '</td>'
          + '</tr>';
      });
      html += '</tbody></table>';
      html += '<p style="font-size:12px;color:#94a3b8;margin-top:8px;">Total: ' + data.total + ' proposals</p>';
      document.getElementById('proposalsList').innerHTML = html;
    } catch (e) {
      showResponse('proposalsResponse', e.message, true);
    }
  }

  // Logout
  function doLogout() {
    token = '';
    localStorage.removeItem('roofmri_token');
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('authStatus').textContent = 'Not logged in';
    document.getElementById('authStatus').style.color = '#64748b';
  }
</script>

</body>
</html>
